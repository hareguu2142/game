<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>수학 대결! 합/불 게임 – Dynamic Edition</title>
  <!-- Animate.css for quick animations -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
  />
  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@300;400;700&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --primary: #0066ff;
      --primary-dark: #0042aa;
      --danger: #e63946;
      --success: #34c759;
      --success-dark: #28a745;
      --surface: #ffffff;
      --surface-alt: #f1f5f9;
      --text: #1e293b;
      --radius: 12px;
      --shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Noto Sans KR", sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top left, #dfe9f3, #ffffff);
      padding: 2rem;
    }

    .container {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 2rem 2.5rem;
      width: 100%;
      max-width: 820px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    h1 {
      font-family: "Jua", sans-serif;
      font-size: 2.4rem;
      color: var(--primary);
      text-align: center;
    }

    h2 {
      font-size: 1.4rem;
      color: var(--text);
      margin-bottom: 0.6rem;
      font-weight: 700;
    }

    /* Buttons */
    button {
      cursor: pointer;
      border: none;
      border-radius: var(--radius);
      padding: 0.55rem 1.1rem;
      font-size: 1rem;
      font-weight: 600;
      color: #ffffff;
      background: var(--primary);
      transition: background 0.25s, transform 0.15s;
    }

    button:hover {
      background: var(--primary-dark);
    }

    button:active {
      transform: scale(0.96);
    }

    /* Button variants */
    .btn-success {
      background: var(--success);
    }
    .btn-success:hover {
      background: var(--success-dark);
    }

    .btn-danger {
      background: var(--danger);
    }
    .btn-danger:hover {
      background: #c82333;
    }

    .btn-info {
      background: #17a2b8;
    }
    .btn-info:hover {
      background: #117a8b;
    }

    /* Layout areas */
    .moderator-controls,
    .player-interaction,
    .score-area {
      display: grid;
      gap: 0.75rem;
    }

    .moderator-controls {
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .player-interaction {
      grid-template-columns: repeat(2, 1fr);
    }

    .game-area {
      display: grid;
      grid-template-columns: 1fr 220px;
      gap: 1.5rem;
      background: var(--surface-alt);
      padding: 1.25rem;
      border-radius: var(--radius);
    }

    .numbers-display h3,
    .target-display h3 {
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    #numberPool {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 0.75rem;
    }

    .number-item {
      background: #ffce45;
      color: var(--text);
      padding: 0.8rem 0;
      border-radius: var(--radius);
      font-size: 1.4rem;
      font-weight: 700;
      text-align: center;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .number-item:hover {
      transform: translateY(-4px) scale(1.06);
    }

    .number-item.removing {
      animation: fadeOutDown 0.5s forwards;
    }

    /* keyframes from animate.css (kept minimal) */
    @keyframes fadeOutDown {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
        transform: translateY(40px);
      }
    }

    #targetNumberDisplay {
      height: 90px;
      background: var(--surface);
      border: 3px dashed var(--danger);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.6rem;
      font-weight: 800;
      color: var(--danger);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.06);
      }
      100% {
        transform: scale(1);
      }
    }

    .message {
      padding: 1rem;
      border-radius: var(--radius);
      font-size: 1.05rem;
      font-weight: 600;
      text-align: center;
      opacity: 0;
      transform: translateY(-15px);
      transition: all 0.4s;
    }

    .message.show {
      opacity: 1;
      transform: translateY(0);
    }

    .msg-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .msg-error {
      background: #fdecea;
      color: #b00020;
      border: 1px solid #f5c6cb;
    }
    .msg-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .score-area {
      background: var(--surface-alt);
      padding: 1rem;
      border-radius: var(--radius);
    }

    .player-score {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.6rem;
    }

    .player-score span {
      flex: 1 1 auto;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .rules-section {
      margin-top: 1rem;
      font-size: 0.95rem;
      color: var(--text);
      line-height: 1.4;
    }

    .rules-section summary {
      cursor: pointer;
      font-weight: 700;
      margin-bottom: 0.4rem;
    }
  </style>
</head>
<body>
  <div class="container animate__animated animate__fadeIn">
    <h1>수학 대결! 합/불 게임</h1>

    <!-- Moderator Controls -->
    <section class="moderator-controls">
      <h2>사회자 컨트롤</h2>
      <button id="startNewSetBtn" class="btn-info">새 숫자 세트 시작</button>
      <button id="nextProblemBtn" class="btn-info">다음 문제 (숫자 제거)</button>
      <button id="revealAnswerBtn" class="btn-success">정답 공개</button>
    </section>

    <!-- Game Area -->
    <section class="game-area">
      <div class="numbers-display">
        <h3>주어진 숫자 (<span id="remainingCount">0</span>개)</h3>
        <div id="numberPool"></div>
      </div>
      <div class="target-display">
        <h3>목표 숫자</h3>
        <div id="targetNumberDisplay">?</div>
      </div>
    </section>

    <!-- Player Interaction -->
    <section class="player-interaction">
      <h2>플레이어 외침</h2>
      <button id="hapBtn" class="btn-success">합!</button>
      <button id="boolBtn" class="btn-danger">불!</button>
    </section>

    <!-- Messages -->
    <div id="messageArea" class="message"></div>

    <!-- Scoreboard -->
    <section class="score-area">
      <h2>점수판</h2>
      <div class="player-score">
        <span>플레이어 1: <span id="player1Score">0</span>점</span>
        <button onclick="updateScore('player1', 1)" class="btn-success">+1점</button>
        <button onclick="updateScore('player1', -2)" class="btn-danger">-2점</button>
      </div>
      <div class="player-score">
        <span>플레이어 2: <span id="player2Score">0</span>점</span>
        <button onclick="updateScore('player2', 1)" class="btn-success">+1점</button>
        <button onclick="updateScore('player2', -2)" class="btn-danger">-2점</button>
      </div>
      <button id="resetScoresBtn" class="btn-danger" style="margin-top:0.5rem">점수 초기화</button>
    </section>

    <!-- Rules collapsible -->
    <details class="rules-section">
      <summary>게임 룰 보기/숨기기</summary>
      <ul>
        <li><strong>게임 목표:</strong> 목표 숫자를 주어진 3개의 숫자 합으로 만들 수 있는지 맞히기.</li>
        <li><strong>합 외치기:</strong> 만들 수 있다면 "합!" (정답 +1, 오답 -2)</li>
        <li><strong>불 외치기:</strong> 만들 수 없다면 "불!" (정답 +1, 오답 -2)</li>
        <li><strong>진행:</strong> 8개 숫자 → 숫자 제거하며 문제 출제 → 5개 이하 시 새 라운드</li>
        <li><strong>승리:</strong> 가장 높은 점수 획득</li>
      </ul>
    </details>
  </div>

  <!-- Confetti Library -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const numberPoolDiv = document.getElementById("numberPool");
      const targetNumberDisplayDiv = document.getElementById("targetNumberDisplay");
      const remainingCountSpan = document.getElementById("remainingCount");
      const messageAreaDiv = document.getElementById("messageArea");

      const startNewSetBtn = document.getElementById("startNewSetBtn");
      const nextProblemBtn = document.getElementById("nextProblemBtn");
      const revealAnswerBtn = document.getElementById("revealAnswerBtn");
      const hapBtn = document.getElementById("hapBtn");
      const boolBtn = document.getElementById("boolBtn");
      const resetScoresBtn = document.getElementById("resetScoresBtn");

      let currentNumbers = [];
      let targetNumber = 0;
      let actualSolutions = [];
      let isActuallyHap = false;

      const scores = { player1: 0, player2: 0 };

      // Helpers
      const randInt = (min, max) =>
        Math.floor(Math.random() * (max - min + 1)) + min;

      function generateUniqueRandomNumbers(count, min, max) {
        const set = new Set();
        while (set.size < count) set.add(randInt(min, max));
        return Array.from(set);
      }

      function displayNumbers() {
        numberPoolDiv.innerHTML = "";
        currentNumbers.forEach((num) => {
          const d = document.createElement("div");
          d.textContent = num;
          d.className = "number-item animate__animated animate__fadeInUp";
          numberPoolDiv.appendChild(d);
        });
        remainingCountSpan.textContent = currentNumbers.length;
      }

      function getAllPossible3Sums(nums) {
        const sums = new Set();
        for (let i = 0; i < nums.length - 2; i++) {
          for (let j = i + 1; j < nums.length - 1; j++) {
            for (let k = j + 1; k < nums.length; k++) {
              sums.add(nums[i] + nums[j] + nums[k]);
            }
          }
        }
        return [...sums];
      }

      function findSumCombinations(nums, target) {
        const res = [];
        const n = nums.length;
        for (let i = 0; i < n - 2; i++) {
          for (let j = i + 1; j < n - 1; j++) {
            for (let k = j + 1; k < n; k++) {
              if (nums[i] + nums[j] + nums[k] === target) {
                res.push([nums[i], nums[j], nums[k]]);
              }
            }
          }
        }
        return res;
      }

      function believableNonSum(possibleSums) {
        const min = Math.min(...possibleSums, 10);
        const max = Math.max(...possibleSums, 60);
        let candidate;
        let attempt = 0;
        do {
          candidate = randInt(min, max);
        } while (possibleSums.includes(candidate) && attempt++ < 100);
        return candidate;
      }

      function generateTarget() {
        if (currentNumbers.length < 3) return false;
        const sums = getAllPossible3Sums(currentNumbers);
        const wantHap = Math.random() < 0.6 && sums.length;
        if (wantHap) {
          targetNumber = sums[randInt(0, sums.length - 1)];
          actualSolutions = findSumCombinations(currentNumbers, targetNumber);
          isActuallyHap = !!actualSolutions.length;
        }
        if (!wantHap || !isActuallyHap) {
          targetNumber = believableNonSum(sums);
          actualSolutions = [];
          isActuallyHap = false;
        }
        targetNumberDisplayDiv.textContent = targetNumber;
        targetNumberDisplayDiv.classList.add("animate__animated", "animate__fadeIn");
        return true;
      }

      function showMessage(msg, type = "info") {
        messageAreaDiv.textContent = msg;
        messageAreaDiv.className = `message show msg-${type}`;
      }

      function startNewSet() {
        currentNumbers = generateUniqueRandomNumbers(8, 1, 20).sort((a, b) => a - b);
        displayNumbers();
        generateTarget();
        showMessage("새로운 숫자 세트가 생성되었습니다!", "info");
        [nextProblemBtn, hapBtn, boolBtn, revealAnswerBtn].forEach((b) => (b.disabled = false));
      }

      function nextProblem() {
        if (currentNumbers.length <= 5) {
          showMessage("라운드 종료! 새 세트 시작.", "info");
          startNewSet();
          return;
        }
        const idx = randInt(0, currentNumbers.length - 1);
        const removed = currentNumbers.splice(idx, 1)[0];
        // animate removal
        const itemEls = [...numberPoolDiv.children];
        const elToRemove = itemEls[idx];
        elToRemove.classList.add("removing");
        elToRemove.addEventListener("animationend", () => {
          elToRemove.remove();
          displayNumbers();
          generateTarget();
          showMessage(`${removed} 제거, 남은 숫자 ${currentNumbers.length}개`, "info");
        });
      }

      function handlePlayerCall(isHapCall) {
        if (targetNumberDisplayDiv.textContent === "?" || targetNumberDisplayDiv.textContent === "-")
          return showMessage("먼저 문제를 시작하세요!", "error");

        const correct = (isHapCall && isActuallyHap) || (!isHapCall && !isActuallyHap);
        if (correct) {
          showMessage(
            isHapCall
              ? `정답! 합 가능합니다: ${actualSolutions[0].join(" + ")} = ${targetNumber}`
              : `정답! 어떤 조합으로도 ${targetNumber} 불가능!`,
            "success"
          );
          confetti({ particleCount: 120, spread: 70, origin: { y: 0.6 } });
        } else {
          showMessage(
            isHapCall
              ? `오답! 불이 맞습니다.`
              : `오답! 합이 맞습니다: ${actualSolutions[0].join(" + ")} = ${targetNumber}`,
            "error"
          );
        }
        [hapBtn, boolBtn].forEach((b) => (b.disabled = true));
      }

      // Event bindings
      startNewSetBtn.addEventListener("click", startNewSet);
      nextProblemBtn.addEventListener("click", nextProblem);
      hapBtn.addEventListener("click", () => handlePlayerCall(true));
      boolBtn.addEventListener("click", () => handlePlayerCall(false));
      revealAnswerBtn.addEventListener("click", () => {
        if (isActuallyHap) {
          showMessage(
            `합! 가능한 조합: ${actualSolutions
              .slice(0, 3)
              .map((a) => a.join(" + "))
              .join(" / ")} = ${targetNumber}`,
            "info"
          );
        } else {
          showMessage(`불! ${targetNumber} 조합 없음`, "info");
        }
        [hapBtn, boolBtn].forEach((b) => (b.disabled = true));
      });

      window.updateScore = function (player, delta) {
        scores[player] += delta;
        document.getElementById(`${player}Score`).textContent = scores[player];
      };

      resetScoresBtn.addEventListener("click", () => {
        scores.player1 = scores.player2 = 0;
        updateScore("player1", 0);
        updateScore("player2", 0);
        showMessage("점수가 초기화되었습니다.", "info");
      });

      // Initial state
      [nextProblemBtn, hapBtn, boolBtn, revealAnswerBtn].forEach((b) => (b.disabled = true));
      showMessage("새 숫자 세트를 시작하세요!", "info");
    });
  </script>
</body>
</html>
